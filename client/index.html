<!DOCTYPE html>
<html lang="tr" >
<head>
  <meta charset="UTF-8" />
  <title>Simple-Peer Video</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
  <style>
    /* Genel sıfırlama */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body, html {
      height: 100%;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #121212;
      color: #eee;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    /* Modal arka plan */
    #modalOverlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.85);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    /* Modal kutusu */
    #modal {
      background: #1e1e1e;
      padding: 30px 40px;
      border-radius: 10px;
      width: 320px;
      box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
      text-align: center;
    }

    #modal h2 {
      margin-bottom: 20px;
      font-weight: 700;
      color: #61dafb;
    }

    #modal input {
      width: 100%;
      padding: 10px 15px;
      margin-bottom: 15px;
      border-radius: 6px;
      border: none;
      font-size: 1rem;
      background: #292929;
      color: #eee;
      outline: none;
      transition: background-color 0.2s ease;
    }

    #modal input:focus {
      background: #3a3a3a;
    }

    #modal button {
      padding: 12px 20px;
      width: 100%;
      background: #61dafb;
      border: none;
      border-radius: 6px;
      font-weight: 700;
      font-size: 1.1rem;
      color: #121212;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    #modal button:hover {
      background: #52c0f0;
    }

    /* Video ve kullanıcı listesi konteyneri */
    #mainContent {
      margin-top: 20px;
      width: 95%;
      max-width: 1200px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
      justify-content: center;
    }

    /* Video container */
    #videos {
      flex: 1 1 720px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap: 15px;
      background: #222;
      padding: 15px;
      border-radius: 12px;
      max-height: 80vh;
      overflow-y: auto;
    }

    video {
      width: 100%;
      height: 160px;
      border-radius: 12px;
      background: black;
      object-fit: cover;
      cursor: pointer;
      border: 3px solid transparent;
      transition: border-color 0.3s ease;
      user-select: none;
    }

    video.screen-share {
      grid-column: span 2;
      height: 350px;
      border-color: #61dafb;
    }

    video:hover {
      border-color: #61dafb;
    }

    /* Kullanıcı listesi */
    #userListContainer {
      width: 240px;
      background: #1e1e1e;
      border-radius: 12px;
      padding: 15px;
      max-height: 80vh;
      overflow-y: auto;
    }

    #userListContainer h3 {
      margin-bottom: 15px;
      color: #61dafb;
      text-align: center;
    }

    #userList {
      list-style: none;
    }

    #userList li {
      padding: 8px 10px;
      border-radius: 8px;
      margin-bottom: 8px;
      background: #292929;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    #userList li.screen-sharing {
      background: #0b78e3;
      font-weight: 700;
      color: white;
    }

    /* Butonlar */
    #controls {
      margin-top: 20px;
      width: 100%;
      max-width: 720px;
      display: flex;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }

    #controls button {
      background: #61dafb;
      border: none;
      padding: 14px 30px;
      font-weight: 700;
      font-size: 1rem;
      border-radius: 8px;
      cursor: pointer;
      color: #121212;
      transition: background-color 0.3s ease;
      user-select: none;
    }
    #controls button:hover {
      background: #52c0f0;
    }

    /* Fullscreen styles */
    .fullscreen {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100vw !important;
      height: 100vh !important;
      z-index: 9999 !important;
      border-radius: 0 !important;
      object-fit: contain !important;
      background-color: black;
    }
  </style>
</head>
<body>
  <!-- Modal for name & room -->
  <div id="modalOverlay">
    <div id="modal">
      <h2>Hoşgeldiniz!</h2>
      <input type="text" id="usernameInput" placeholder="Adınızı girin" />
      <input type="text" id="roomIdInput" placeholder="Oda ID girin" />
      <button id="joinBtn">Bağlan</button>
    </div>
  </div>

  <div id="mainContent" style="display:none;">
    <div id="controls">
      <button id="shareScreen" title="Ekranını paylaş">Ekranı Paylaş</button>
      <button id="shareCamera" title="Kameranı aç">Kamerayı Aç</button>
    </div>

    <div id="videos"></div>

    <div id="userListContainer">
      <h3>Kullanıcılar</h3>
      <ul id="userList"></ul>
    </div>
  </div>

  <script>
    let socket;
    let localStream = null;
    const peers = {};
    let screenSharerId = null;
    let username = "";
    let roomId = "";

    const modalOverlay = document.getElementById("modalOverlay");
    const joinBtn = document.getElementById("joinBtn");

    // Modal submit handler
    joinBtn.onclick = () => {
      username = document.getElementById("usernameInput").value.trim();
      roomId = document.getElementById("roomIdInput").value.trim();
      if (!username || !roomId) {
        alert("Lütfen adınızı ve oda ID'nizi girin.");
        return;
      }
      modalOverlay.style.display = "none";
      document.getElementById("mainContent").style.display = "flex";

      initSocket();
    };

    function initSocket() {
      socket = io("https://video-app-lcl0.onrender.com");

      socket.emit("join-room", { roomId, username });

      socket.on("update-user-list", (users) => {
        updateUserList(users);
      });

      socket.on("screen-share-started", (userId) => {
        screenSharerId = userId;
        updateUserList();
        updateVideoStyles();
      });

      socket.on("screen-share-stopped", () => {
        screenSharerId = null;
        updateUserList();
        updateVideoStyles();
      });

      socket.on("user-joined", (userId) => {
        if (peers[userId]) return; // zaten varsa
        createPeer(userId, true);
      });

      socket.on("signal", ({ from, signal }) => {
        if (!peers[from]) {
          createPeer(from, false);
        }
        peers[from].signal(signal);
      });

      socket.on("user-left", (userId) => {
        removePeer(userId);
      });
    }

    // Kullanıcı listesi güncelle
    let currentUsers = [];
    function updateUserList(users) {
      if (users) currentUsers = users;
      const userList = document.getElementById("userList");
      userList.innerHTML = "";

      currentUsers.forEach(user => {
        const li = document.createElement("li");
        li.textContent = user.name;
        li.title = user.id;
        if (user.id === screenSharerId) {
          li.classList.add("screen-sharing");
          li.textContent += " (Ekran Paylaşıyor)";
        }
        userList.appendChild(li);
      });
    }

    // Peer oluşturma
    function createPeer(userId, initiator) {
      const peer = new SimplePeer({
        initiator,
        trickle: false,
        stream: localStream,
      });

      peer.on("signal", (signal) => {
        socket.emit("signal", { target: userId, signal });
      });

      peer.on("stream", (stream) => {
        addVideo(userId, stream);
      });

      peer.on("close", () => {
        removePeer(userId);
      });

      peers[userId] = peer;
      return peer;
    }

    // Video elementini ekle / güncelle
    function addVideo(userId, stream) {
      let video = document.getElementById("video-" + userId);
      if (!video) {
        video = document.createElement("video");
        video.id = "video-" + userId;
        video.autoplay = true;
        video.playsInline = true;
        video.addEventListener("click", toggleFullScreen);
        document.getElementById("videos").appendChild(video);
      }
      video.srcObject = stream;
      updateVideoStyles();
    }

    // Video kutusu stillerini güncelle
    function updateVideoStyles() {
      for (const user of currentUsers) {
        const video = document.getElementById("video-" + user.id);
        if (!video) continue;
        if (user.id === screenSharerId) {
          video.classList.add("screen-share");
        } else {
          video.classList.remove("screen-share");
        }
      }
    }

    // Peer sil
    function removePeer(userId) {
      if (peers[userId]) {
        peers[userId].destroy();
        delete peers[userId];
      }
      const video = document.getElementById("video-" + userId);
      if (video) {
        video.remove();
      }
      // Güncelle kullanıcı listesi
      currentUsers = currentUsers.filter(u => u.id !== userId);
      updateUserList();
    }

    // Lokal kamerayı aç
    document.getElementById("shareCamera").onclick = async () => {
      try {
        localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        addLocalVideo();
        replaceStreamsInPeers();
      } catch (err) {
        alert("Kamera açılırken hata: " + err.message);
      }
    };

    // Ekran paylaş
    document.getElementById("shareScreen").onclick = async () => {
      try {
        socket.emit("start-screen-share");

        const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
        const micStream = await navigator.mediaDevices.getUserMedia({ audio: true });

        localStream = new MediaStream([
          ...screenStream.getVideoTracks(),
          ...micStream.getAudioTracks()
        ]);
        addLocalVideo();
        replaceStreamsInPeers();

        // Ekran paylaşımı bittiğinde event tetikle
        screenStream.getVideoTracks()[0].addEventListener("ended", () => {
          socket.emit("stop-screen-share");
        });
      } catch (err) {
        alert("Ekran paylaşımı başlatılırken hata: " + err.message);
      }
    };

    // Local video ekle / güncelle
    function addLocalVideo() {
      let localVideo = document.getElementById("localVideo");
      if (!localVideo) {
        localVideo = document.createElement("video");
        localVideo.id = "localVideo";
        localVideo.muted = true;
        localVideo.autoplay = true;
        localVideo.playsInline = true;
        localVideo.addEventListener("click", toggleFullScreen);
        document.getElementById("videos").appendChild(localVideo);
      }
      localVideo.srcObject = localStream;
      updateVideoStyles();
    }

    // Peer'lara stream değiştir
    function replaceStreamsInPeers() {
      for (const peer of Object.values(peers)) {
        localStream.getTracks().forEach(track => {
          const sender = peer._pc.getSenders().find(s => s.track?.kind === track.kind);
          if (sender) sender.replaceTrack(track);
          else peer.addTrack(track, localStream);
        });
      }
    }

    // Video tıklayınca fullscreen aç/kapa
    function toggleFullScreen(e) {
      const video = e.target;
      if (!document.fullscreenElement) {
        video.classList.add("fullscreen");
        video.requestFullscreen?.();
      } else {
        document.exitFullscreen?.();
        video.classList.remove("fullscreen");
      }
    }
  </script>
</body>
</html>
